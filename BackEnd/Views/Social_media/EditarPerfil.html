<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil - Feed Claro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- ESTILOS VISUAIS --- */
        :root {
            --primary-color: #f0f2f5;
            --secondary-color: #ffffff;
            --accent-color: #ffd700;
            --text-color: #333;
            --border-color: #dbdbdb;
            --tiktok-bg: #f0f2f5;
            --tiktok-header-bg: #fff;
            --tiktok-card-bg: #fff;
            --tiktok-card-border: #e0e0e0;
            --tiktok-icon-color: #666;
            --tiktok-accent-text: #333;
            --error-color: #c0392b;
            --delete-color: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tiktok-bg);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
        }

        .app-container { width: 100%; max-width: 600px; background-color: var(--secondary-color); position: relative; }
        .app-header { background-color: var(--tiktok-header-bg); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--tiktok-card-border); position: sticky; top: 0; z-index: 100; }
        .app-header h2 { font-size: 1.2rem; font-weight: 600; }
        .header-action { font-size: 1.5rem; color: var(--tiktok-icon-color); text-decoration: none; }
        .header-save-btn { background: none; border: none; color: var(--accent-color); font-size: 1rem; font-weight: 700; cursor: pointer; }
        .page-content { padding: 20px 15px 80px 15px; }
        .profile-picture-editor { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
        .picture-wrapper { position: relative; cursor: pointer; }
        .profile-picture-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .picture-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 2rem; opacity: 0; transition: opacity 0.2s ease; }
        .picture-wrapper:hover .picture-overlay { opacity: 1; }
        .change-photo-text { font-weight: 600; color: var(--text-color); margin-top: 10px; }
        #foto_perfil_input { display: none; }
        .edit-profile-form .form-group { margin-bottom: 20px; }
        .edit-profile-form label { display: block; font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 8px; }
        .edit-profile-form input[type="text"], .edit-profile-form input[type="email"], .edit-profile-form input[type="password"], .edit-profile-form input[type="date"], .edit-profile-form textarea, .edit-profile-form select { width: 100%; padding: 12px 15px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--primary-color); color: var(--text-color); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .edit-profile-form input::placeholder, .edit-profile-form textarea::placeholder { color: #999; }
        .edit-profile-form input:focus, .edit-profile-form textarea:focus, .edit-profile-form select:focus { outline: none; border-color: var(--accent-color); background-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.25); }
        .edit-profile-form textarea { min-height: 100px; resize: vertical; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .password-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .password-note { font-size: 0.85rem; color: #777; margin-bottom: 15px; }
        .action-button { display: block; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 15px; transition: background-color 0.2s ease; }
        .save-button { background-color: var(--accent-color); color: var(--tiktok-accent-text); }
        .save-button:hover { background-color: #e6c300; }
        .save-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .delete-button { background-color: transparent; color: var(--delete-color); border: 1px solid var(--delete-color); }
        .delete-button:hover { background-color: var(--delete-color); color: white; }
        .form-error-message { color: var(--error-color); font-size: 0.85rem; margin-top: 5px; display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); text-align: center; max-width: 90%; width: 400px; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 15px; font-size: 1.4rem; }
        .modal-content p { margin-bottom: 25px; color: #666; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .modal-btn-confirm { background-color: var(--delete-color); color: white; }
        .modal-btn-confirm:hover { background-color: #c0392b; }
        .modal-btn-confirm:disabled { background-color: #ccc; cursor: not-allowed; }
        .modal-btn-cancel { background-color: #f0f2f5; color: #333; }
        .modal-btn-cancel:hover { background-color: #e1e3e6; }
        
        .list-manager { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .item-list { margin-bottom: 20px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--primary-color); padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; }
        .list-item span { font-weight: 500; }
        .list-item .level { color: #777; font-size: 0.9rem; margin-left: 10px; text-transform: capitalize; }
        .list-item button { background: none; border: none; color: var(--delete-color); cursor: pointer; font-size: 1.2rem; padding: 5px; line-height: 1; }
        .add-item-controls { display: flex; gap: 10px; align-items: stretch; }
        .add-item-controls select { flex: 1; }
        .add-item-btn { padding: 0 18px; background-color: var(--tiktok-icon-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
        .add-item-btn:hover { background-color: #555; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <a href="#" class="header-action"><i class="fas fa-arrow-left"></i></a>
            <h2>Editar Perfil</h2>
            <button class="header-save-btn" id="header-save-btn">Salvar</button>
        </header>

        <main class="page-content">
            <form id="edit-profile-form" class="edit-profile-form">
                <div class="profile-picture-editor">
                    <label for="foto_perfil_input" class="picture-wrapper">
                        <img src="" alt="Foto de Perfil" class="profile-picture-preview" id="profile-pic-preview">
                        <div class="picture-overlay"><i class="fas fa-camera"></i></div>
                    </label>
                    <input type="file" id="foto_perfil_input" name="foto_perfil" accept="image/*">
                    <span class="change-photo-text">Alterar foto de perfil</span>
                </div>
                <div class="form-group"><label for="nome_completo">Nome Completo</label><input type="text" id="nome_completo" name="nome_completo" placeholder="Carregando..."></div>
                <div class="form-group"><label for="username">Nome de Usuário</label><input type="text" id="username" name="username" placeholder="Carregando..."></div>
                
                <!-- Campos específicos para Empresa -->
                <div class="form-group" id="cnpj-group" style="display: none;"><label for="cnpj">CNPJ</label><input type="text" id="cnpj" name="cnpj" placeholder="Digite o CNPJ da empresa"></div>
                <div class="form-group" id="setor-group" style="display: none;"><label for="setor">Setor de Atuação</label><input type="text" id="setor" name="setor" placeholder="Ex: Varejo Esportivo"></div>

                <div class="form-group"><label for="biografia">Biografia</label><textarea id="biografia" name="biografia" placeholder="Carregando..."></textarea></div>
                <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" name="email" placeholder="Carregando..."></div>
                <div class="form-row"><div class="form-group"><label for="estado">Estado</label><select id="estado" name="estado"><option value="">Carregando estados...</option></select></div><div class="form-group"><label for="cidade">Cidade</label><select id="cidade" name="cidade" disabled><option value="">Selecione um estado primeiro</option></select></div></div>
                
                <!-- Campo específico para Usuário -->
                <div class="form-group" id="data-nascimento-group"><label for="data_nascimento">Data de Nascimento</label><input type="date" id="data_nascimento" name="data_nascimento"></div>
                
                <!-- Gerenciador de Esportes para Usuários -->
                <div class="list-manager" id="sports-manager" style="display: none;">
                    <label style="margin-bottom: 15px;">Esportes Praticados</label>
                    <div id="sports-list" class="item-list"></div>
                    <div class="add-item-controls">
                        <select id="new-sport-name-select"><option value="">Carregando esportes...</option></select>
                        <select id="new-sport-level-select"><option value="Amador">Amador</option><option value="Iniciante">Iniciante</option><option value="Profissional">Profissional</option></select>
                        <button type="button" id="add-sport-btn" class="add-item-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div class="password-section">
                    <p class="password-note">Deixe os campos abaixo em branco se não desejar alterar sua senha.</p>
                    <div class="form-group"><label for="senha">Nova Senha</label><input type="password" id="senha" name="senha" placeholder="••••••••"></div>
                    <div class="form-group"><label for="confirmar_senha">Confirmar Nova Senha</label><input type="password" id="confirmar_senha" name="confirmar_senha" placeholder="••••••••"><p id="password-match-error" class="form-error-message">As senhas não coincidem.</p></div>
                </div>
                <button type="submit" class="action-button save-button" id="main-save-btn">Salvar Alterações</button>
                <button type="button" class="action-button delete-button" id="delete-account-btn">Excluir Conta</button>
            </form>
        </main>
    </div>

    <div class="modal-overlay" id="delete-confirm-modal"><div class="modal-content"><h3>Confirmar Exclusão</h3><p>Você tem certeza que deseja excluir sua conta? Esta ação é permanente e todos os seus dados serão removidos.</p><div class="modal-actions"><button class="modal-btn modal-btn-cancel" id="cancel-delete-btn">Cancelar</button><button class="modal-btn modal-btn-confirm" id="confirm-delete-btn">Sim, excluir</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIGURAÇÕES E SELETORES ---
            const token = localStorage.getItem('jwtToken');
            const API_BASE_URL = 'http://127.0.0.1:5000';
            const IBGE_API_URL = 'https://servicodados.ibge.gov.br/api/v1/localidades';

            // Seletores do formulário
            const form = document.getElementById('edit-profile-form');
            const profilePicPreview = document.getElementById('profile-pic-preview');
            const fileInput = document.getElementById('foto_perfil_input');
            const nomeCompletoInput = document.getElementById('nome_completo');
            const usernameInput = document.getElementById('username');
            const biografiaInput = document.getElementById('biografia');
            const emailInput = document.getElementById('email');
            const estadoSelect = document.getElementById('estado');
            const cidadeSelect = document.getElementById('cidade');
            const senhaInput = document.getElementById('senha');
            const confirmarSenhaInput = document.getElementById('confirmar_senha');
            const passwordErrorMsg = document.getElementById('password-match-error');
            const mainSaveBtn = document.getElementById('main-save-btn');
            const headerSaveBtn = document.getElementById('header-save-btn');
            
            // Seletores específicos de tipo de usuário
            const cnpjInput = document.getElementById('cnpj');
            const cnpjGroup = document.getElementById('cnpj-group');
            const setorInput = document.getElementById('setor');
            const setorGroup = document.getElementById('setor-group');
            const dataNascimentoInput = document.getElementById('data_nascimento');
            const dataNascimentoGroup = document.getElementById('data-nascimento-group');

            // Seletores de Modal e Exclusão
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            // Seletores para Esportes (Usuário)
            const sportsManagerSection = document.getElementById('sports-manager');
            const sportsListContainer = document.getElementById('sports-list');
            const newSportNameSelect = document.getElementById('new-sport-name-select');
            const newSportLevelSelect = document.getElementById('new-sport-level-select');
            const addSportBtn = document.getElementById('add-sport-btn');
            
            let userSports = {};
            let userType = 'usuario'; // Padrão
            let apiEndpoints = {};

            // ======================================================= //
            // --- LÓGICA DE USUÁRIO E INICIALIZAÇÃO               --- //
            // ======================================================= //

            function decodeJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    console.error("Erro ao decodificar o token:", e);
                    return null;
                }
            }

            function setApiEndpoints(type) {
                if (type === 'empresa') {
                    apiEndpoints = {
                        getProfile: `${API_BASE_URL}/usuarioEmpresa/MeuPerfil`,
                        updateProfile: `${API_BASE_URL}/usuarioEmpresa/EditarEmpresa`,
                        deleteAccount: `${API_BASE_URL}/usuarioEmpresa/ExcluirUsuario`
                    };
                } else {
                    apiEndpoints = {
                        getProfile: `${API_BASE_URL}/usuario/MeuPerfil`,
                        updateProfile: `${API_BASE_URL}/usuario/EditarUsuario`,
                        deleteAccount: `${API_BASE_URL}/usuario/ExcluirUsuario`
                    };
                }
            }
            
            // Ajusta a UI com base no tipo de usuário
            function adjustUiForUserType() {
                if (userType === 'empresa') {
                    document.querySelector('label[for="nome_completo"]').textContent = 'Nome da Empresa';
                    document.querySelector('label[for="biografia"]').textContent = 'Sobre a Empresa';
                    cnpjGroup.style.display = 'block';
                    setorGroup.style.display = 'block';
                    dataNascimentoGroup.style.display = 'none';
                    sportsManagerSection.style.display = 'none';
                } else { // usuário
                    cnpjGroup.style.display = 'none';
                    setorGroup.style.display = 'none';
                    dataNascimentoGroup.style.display = 'block';
                    sportsManagerSection.style.display = 'block';
                }
            }

            // --- FUNÇÕES DE API ---
            
            async function loadSports() {
                try {
                    const response = await fetch(`${API_BASE_URL}/esportes/ListarEsportes`);
                    if (!response.ok) throw new Error('Falha ao buscar esportes.');
                    const sports = await response.json();
                    newSportNameSelect.innerHTML = '<option value="">Selecione um esporte</option>';
                    sports.sort((a, b) => a.nome.localeCompare(b.nome));
                    sports.forEach(sport => {
                        const option = document.createElement('option');
                        option.value = sport.nome;
                        option.textContent = sport.nome;
                        newSportNameSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Erro ao buscar esportes:", error);
                    newSportNameSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            }
            
            async function loadStates() { 
                try {
                    const response = await fetch(`${IBGE_API_URL}/estados`);
                    if (!response.ok) throw new Error('Falha ao buscar estados.');
                    const states = await response.json();
                    estadoSelect.innerHTML = '<option value="">Selecione um estado</option>';
                    states.sort((a, b) => a.nome.localeCompare(b.nome));
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.sigla;
                        option.textContent = state.nome;
                        estadoSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Erro ao buscar estados:", error);
                    estadoSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            }
            
            async function loadCities(stateSigla) { 
                if (!stateSigla) {
                    cidadeSelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                    cidadeSelect.disabled = true;
                    return;
                }
                cidadeSelect.innerHTML = '<option value="">Carregando cidades...</option>';
                cidadeSelect.disabled = true;
                try {
                    const response = await fetch(`${IBGE_API_URL}/estados/${stateSigla}/municipios`);
                    if (!response.ok) throw new Error('Falha ao buscar cidades.');
                    const cities = await response.json();
                    cidadeSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.nome;
                        option.textContent = city.nome;
                        cidadeSelect.appendChild(option);
                    });
                    cidadeSelect.disabled = false;
                } catch (error) {
                    console.error("Erro ao buscar cidades:", error);
                    cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                }
            }

            // --- FUNÇÕES DE DADOS DO USUÁRIO ---
            async function loadUserProfile() { 
                if (!token) {
                    alert('Erro de autenticação: Token não encontrado.');
                    window.location.href = '/login.html';
                    return;
                }
                try {
                    const response = await fetch(apiEndpoints.getProfile, {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const userData = await response.json();
                    if (!response.ok) throw new Error(userData.erro || `Erro: ${response.statusText}`);
                    await populateForm(userData);
                } catch (error) {
                    console.error('Erro ao carregar perfil:', error);
                    alert('Não foi possível carregar seus dados.');
                }
            }

            async function populateForm(data) {
                profilePicPreview.src = data.foto_perfil || 'default-avatar.png';
                nomeCompletoInput.value = data.nome_completo || data.nome || ''; 
                usernameInput.value = data.username || '';
                biografiaInput.value = data.biografia || '';
                emailInput.value = data.email || '';
                
                if (userType === 'empresa') {
                    cnpjInput.value = data.cnpj || ''; 
                    setorInput.value = data.setor || ''; // Preenche o campo de setor único
                } else { // Usuário
                    if (data.data_nascimento) {
                        const birthDate = new Date(data.data_nascimento);
                        dataNascimentoInput.value = `${birthDate.getUTCFullYear()}-${String(birthDate.getUTCMonth() + 1).padStart(2, '0')}-${String(birthDate.getUTCDate()).padStart(2, '0')}`;
                    }
                    userSports = data.esportes_praticados && typeof data.esportes_praticados === 'object' ? data.esportes_praticados : {};
                    renderSportsList();
                }

                if (data.estado) {
                    estadoSelect.value = data.estado;
                    await loadCities(data.estado);
                    if (data.cidade) {
                        cidadeSelect.value = data.cidade;
                    }
                }
            }
            
            // --- FUNÇÕES PARA GERENCIAR ESPORTES (USUÁRIO) ---
            function renderSportsList() {
                sportsListContainer.innerHTML = '';
                if (Object.keys(userSports).length === 0) {
                    sportsListContainer.innerHTML = '<p style="color: #888; text-align: center; margin-bottom: 15px;">Nenhum esporte adicionado.</p>';
                    return;
                }
                for (const sportName in userSports) {
                    const level = userSports[sportName];
                    const sportItem = document.createElement('div');
                    sportItem.className = 'list-item';
                    sportItem.innerHTML = `<div><span>${sportName}</span><span class="level">(${level})</span></div><button type="button" class="remove-sport-btn" data-sport="${sportName}" title="Remover esporte">&times;</button>`;
                    sportsListContainer.appendChild(sportItem);
                }
                document.querySelectorAll('.remove-sport-btn').forEach(button => button.addEventListener('click', handleRemoveSport));
            }

            function handleAddSport() {
                const name = newSportNameSelect.value;
                const level = newSportLevelSelect.value;
                if (!name) { alert('Por favor, selecione um esporte da lista.'); return; }
                userSports[name] = level;
                newSportNameSelect.value = '';
                renderSportsList();
            }

            function handleRemoveSport(event) {
                const sportNameToRemove = event.currentTarget.dataset.sport;
                if (sportNameToRemove && userSports.hasOwnProperty(sportNameToRemove)) {
                    delete userSports[sportNameToRemove];
                    renderSportsList();
                }
            }

            // --- FUNÇÃO DE ENVIO ---
            async function handleFormSubmit(event) {
                event.preventDefault();
                if (!token) { alert('Erro de autenticação: Token não encontrado.'); return; }
                if (senhaInput.value !== confirmarSenhaInput.value) { alert('As senhas não coincidem.'); return; }
                
                setButtonsLoading(true);

                const formData = new FormData();
                const updateConfig = {
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                };

                if (userType === 'empresa') {
                    updateConfig.method = 'POST';
                    formData.append('nome', nomeCompletoInput.value);
                    formData.append('cnpj', cnpjInput.value);
                    formData.append('setor', setorInput.value); // Envia o valor do campo de setor
                } else { // Usuário
                    updateConfig.method = 'PUT';
                    formData.append('nome_completo', nomeCompletoInput.value);
                    formData.append('data_nascimento', dataNascimentoInput.value);
                    formData.append('esportes_praticados', JSON.stringify(userSports));
                }
                
                formData.append('username', usernameInput.value);
                formData.append('biografia', biografiaInput.value);
                formData.append('email', emailInput.value);
                formData.append('estado', estadoSelect.value);
                formData.append('cidade', cidadeSelect.value);
                
                if (senhaInput.value) { formData.append('senha', senhaInput.value); }
                if (fileInput.files[0]) { formData.append('foto_perfil', fileInput.files[0]); }
                
                try {
                    const response = await fetch(apiEndpoints.updateProfile, updateConfig);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.erro || 'Ocorreu um erro ao salvar.');
                    alert(result.mensagem || 'Perfil atualizado com sucesso!');
                } catch (error) {
                    console.error('Falha ao salvar o perfil:', error);
                    alert(`Erro: ${error.message}`);
                } finally {
                    setButtonsLoading(false);
                }
            }

            // --- FUNÇÃO DE EXCLUSÃO DE CONTA ---
            async function handleDeleteAccount() {
                if (!token) { alert('Erro de autenticação: Token não encontrado.'); return; }

                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.textContent = 'Excluindo...';

                try {
                    const response = await fetch(apiEndpoints.deleteAccount, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.erro || 'Não foi possível excluir a conta.');
                    
                    alert(result.mensagem || "Sua conta foi excluída com sucesso.");
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/login.html';

                } catch (error) {
                    alert(`Erro ao excluir conta: ${error.message}`);
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'Sim, excluir';
                    deleteConfirmModal.classList.remove('show');
                }
            }
            
            // --- FUNÇÕES AUXILIARES, LISTENERS E INICIALIZAÇÃO ---
            function validatePasswordsOnInput() {
                if (senhaInput.value !== confirmarSenhaInput.value && confirmarSenhaInput.value) {
                    passwordErrorMsg.style.display = 'block';
                } else {
                    passwordErrorMsg.style.display = 'none';
                }
            }

            function setButtonsLoading(isLoading) {
                mainSaveBtn.disabled = isLoading;
                headerSaveBtn.disabled = isLoading;
                mainSaveBtn.textContent = isLoading ? 'Salvando...' : 'Salvar Alterações';
            }

            function setupEventListeners() {
                form.addEventListener('submit', handleFormSubmit);
                headerSaveBtn.addEventListener('click', () => form.requestSubmit());
                fileInput.addEventListener('change', () => {
                    if (fileInput.files && fileInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => { profilePicPreview.src = e.target.result; };
                        reader.readAsDataURL(fileInput.files[0]);
                    }
                });
                estadoSelect.addEventListener('change', () => loadCities(estadoSelect.value));
                senhaInput.addEventListener('input', validatePasswordsOnInput);
                confirmarSenhaInput.addEventListener('input', validatePasswordsOnInput);
                
                addSportBtn.addEventListener('click', handleAddSport);

                deleteAccountBtn.addEventListener('click', () => deleteConfirmModal.classList.add('show'));
                cancelDeleteBtn.addEventListener('click', () => deleteConfirmModal.classList.remove('show'));
                confirmDeleteBtn.addEventListener('click', handleDeleteAccount);
            }

            async function initializePage() {
                console.log("Iniciando página de edição de perfil...");
                if (!token) {
                    alert('Sessão inválida. Por favor, faça login novamente.');
                    window.location.href = '/login.html';
                    return;
                }
                
                const userData = decodeJwt(token);
                if (userData && userData.tipo_usuario) {
                    userType = userData.tipo_usuario;
                }
                console.log(`Tipo de usuário detectado: ${userType}`);

                setApiEndpoints(userType);
                adjustUiForUserType();
                setupEventListeners();

                const promises = [loadStates(), loadUserProfile()];
                if (userType === 'usuario') {
                    promises.push(loadSports());
                }

                await Promise.all(promises);
                console.log("Página carregada e pronta.");
            }

            initializePage();
        });
    </script>
</body>
</html>